<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mizu Notes - Bloc de Notas Offline</title>
    <!-- No hay CSS aquí - se genera dinámicamente -->
</head>
<body>
    <div class="container animate-fadeIn">
        <h1 class="text-gradient">Mizu Notes</h1>
        <p class="subtitle text-center">Bloc de notas offline-first con sincronización inteligente</p>

        <!-- Barra de herramientas -->
        <div class="toolbar">
            <button class="toolbar-btn primary" id="newNoteBtn">
                📄 Nueva Nota
            </button>
            <button class="toolbar-btn danger" id="deleteNoteBtn">
                🗑️ Eliminar
            </button>
            <button class="toolbar-btn" id="exportBtn">
                📤 Exportar
            </button>
            <button class="toolbar-btn" id="importBtn">
                📥 Importar
            </button>
            
            <!-- Botón de Login agregado -->
            <button class="toolbar-btn" id="loginBtn">
                👤 Login
            </button>
            
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Conectado</span>
            </div>
        </div>

        <!-- Contenido principal -->
        <div class="main-content flex">
            <!-- Sidebar con lista de notas -->
            <div class="notes-sidebar">
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="Buscar notas...">
                    <div class="search-icon">🔍</div>
                </div>
                
                <div class="notes-list" id="notesList">
                    <!-- Las notas se cargarán aquí -->
                </div>

                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="totalNotes">0</div>
                        <div class="stat-label">Notas</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalChars">0</div>
                        <div class="stat-label">Caracteres</div>
                    </div>
                </div>
            </div>

            <!-- Editor de notas -->
            <div class="editor-container">
                <input 
                    type="text" 
                    id="noteTitle" 
                    class="note-title-input" 
                    placeholder="Título de la nota..."
                    maxlength="100"
                >
                <textarea 
                    id="noteContent" 
                    class="note-content" 
                    placeholder="Escribe tu nota aquí..."
                    spellcheck="true"
                ></textarea>
                
                <div class="note-info">
                    <div>
                        <span id="charCount">0 caracteres</span>
                        <span> • </span>
                        <span id="wordCount">0 palabras</span>
                    </div>
                    <div class="auto-save" id="autoSaveIndicator">✓ Guardado</div>
                    <div id="lastSaved">Última edición: nunca</div>
                </div>
            </div>
        </div>

        <!-- Mensaje de estado -->
        <div id="messageBox" role="alert"></div>
    </div>

    <!-- Modal de Login/Registro -->
    <div id="loginModal" class="login-modal">
        <div class="login-content">
            <button class="close-modal" id="closeLoginModal">×</button>
            
            <div class="login-tabs">
                <button class="login-tab active" data-tab="login">Iniciar Sesión</button>
                <button class="login-tab" data-tab="register">Registrarse</button>
            </div>

            <!-- Formulario de Login -->
            <form id="loginForm" class="login-form active">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="tu@email.com" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Contraseña</label>
                    <input type="password" id="loginPassword" placeholder="Tu contraseña" required>
                </div>
                <button type="submit" class="login-btn">Iniciar Sesión</button>
                
                <div class="social-login">
                    <button type="button" class="social-btn" id="googleLogin">
                        <span>🔐</span> Continuar con Google
                    </button>
                    <button type="button" class="social-btn" id="githubLogin">
                        <span>🐙</span> Continuar con GitHub
                    </button>
                </div>
            </form>

            <!-- Formulario de Registro -->
            <form id="registerForm" class="login-form">
                <div class="form-group">
                    <label for="registerName">Nombre</label>
                    <input type="text" id="registerName" placeholder="Tu nombre completo" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" placeholder="tu@email.com" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Contraseña</label>
                    <input type="password" id="registerPassword" placeholder="Mínimo 6 caracteres" required minlength="6">
                </div>
                <button type="submit" class="login-btn">Crear Cuenta</button>
                
                <div class="social-login">
                    <button type="button" class="social-btn" id="googleRegister">
                        <span>🔐</span> Registrarse con Google
                    </button>
                    <button type="button" class="social-btn" id="githubRegister">
                        <span>🐙</span> Registrarse con GitHub
                    </button>
                </div>
            </form>
        </div>
    </div>

   <script type="module" src="./src/frontend/app.js"></script>
   
   <!-- Script del Modal de Login con Supabase -->
   <script type="module">
        // Importar Supabase
        import { SupabaseAuth } from './src/frontend/core/auth/SupabaseClient.js';

        // Sistema de Autenticación - Modal
        class AuthModal {
            constructor() {
                this.modal = document.getElementById('loginModal');
                this.auth = new SupabaseAuth();
                this.initEventListeners();
                this.checkCurrentUser();
            }

            async checkCurrentUser() {
                const result = await this.auth.getCurrentUser();
                if (result.success && result.user) {
                    this.updateUIForLoggedInUser(result.user);
                }
            }

            updateUIForLoggedInUser(user) {
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.innerHTML = `👤 ${user.email}`;
                loginBtn.title = `Cerrar sesión (${user.email})`;
                
                // Cambiar el comportamiento del botón para logout
                loginBtn.onclick = () => this.handleLogout();
                
                // Agregar estilo diferente para indicar que está logeado
                loginBtn.classList.add('logged-in');
            }

            updateUIForLoggedOut() {
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.innerHTML = '👤 Login';
                loginBtn.title = 'Iniciar sesión';
                loginBtn.onclick = () => this.show();
                loginBtn.classList.remove('logged-in');
            }

            async handleLogout() {
                const result = await this.auth.signOut();
                if (result.success) {
                    this.updateUIForLoggedOut();
                    this.showMessage('✅ Sesión cerrada correctamente', 'success');
                    
                    // Recargar la página para limpiar estado
                    setTimeout(() => location.reload(), 1000);
                } else {
                    this.showMessage(`❌ Error: ${result.error}`, 'error');
                }
            }

            initEventListeners() {
                // Tabs de login/registro
                document.querySelectorAll('.login-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => this.switchTab(e.target));
                });

                // Cerrar modal
                document.getElementById('closeLoginModal').addEventListener('click', () => this.hide());
                
                // Cerrar al hacer click fuera del modal
                this.modal.addEventListener('click', (e) => {
                    if (e.target === this.modal) this.hide();
                });

                // Formularios
                document.getElementById('loginForm').addEventListener('submit', (e) => this.handleLogin(e));
                document.getElementById('registerForm').addEventListener('submit', (e) => this.handleRegister(e));

                // Botones sociales
                document.getElementById('googleLogin').addEventListener('click', () => this.socialLogin('google'));
                document.getElementById('githubLogin').addEventListener('click', () => this.socialLogin('github'));
                document.getElementById('googleRegister').addEventListener('click', () => this.socialLogin('google'));
                document.getElementById('githubRegister').addEventListener('click', () => this.socialLogin('github'));
            }

            switchTab(clickedTab) {
                // Actualizar tabs activos
                document.querySelectorAll('.login-tab').forEach(tab => tab.classList.remove('active'));
                clickedTab.classList.add('active');

                // Mostrar formulario correspondiente
                const tabType = clickedTab.dataset.tab;
                document.querySelectorAll('.login-form').forEach(form => form.classList.remove('active'));
                document.getElementById(`${tabType}Form`).classList.add('active');
            }

            show() {
                this.modal.classList.add('active');
                // Reset forms
                document.getElementById('loginForm').reset();
                document.getElementById('registerForm').reset();
                // Mostrar login por defecto
                document.querySelector('.login-tab[data-tab="login"]').click();
            }

            hide() {
                this.modal.classList.remove('active');
            }

            async handleLogin(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                this.showMessage('🔐 Conectando...', 'info');
                
                const result = await this.auth.signIn(email, password);
                if (result.success) {
                    this.showMessage('✅ ¡Bienvenido!', 'success');
                    this.updateUIForLoggedInUser(result.user);
                    this.hide();
                } else {
                    this.showMessage(`❌ ${result.error}`, 'error');
                }
            }

            async handleRegister(e) {
                e.preventDefault();
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                
                this.showMessage('📝 Creando cuenta...', 'info');
                
                const result = await this.auth.signUp(email, password, name);
                if (result.success) {
                    this.showMessage(result.message || '✅ ¡Cuenta creada!', 'success');
                    // Cambiar a pestaña de login
                    document.querySelector('.login-tab[data-tab="login"]').click();
                } else {
                    this.showMessage(`❌ ${result.error}`, 'error');
                }
            }

            async socialLogin(provider) {
                this.showMessage(`🔗 Conectando con ${provider}...`, 'info');
                
                const result = await this.auth.signInWithProvider(provider, 'https://mizulegendsstudios.github.io/mizu_notes/auth/callback.html');
                if (result.success && result.url) {
                    // Redirigir a OAuth
                    window.location.href = result.url;
                } else {
                    this.showMessage(`❌ Error: ${result.error}`, 'error');
                }
            }

            showMessage(message, type = 'info') {
                // Usar el sistema de mensajes existente de la app
                if (window.app && window.app.displayMessage) {
                    window.app.displayMessage(message, type === 'error');
                } else {
                    // Fallback temporal
                    const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue';
                    console.log(`%c${message}`, `color: ${color}; font-weight: bold;`);
                }
            }
        }

        // Inicializar el modal cuando cargue la página
        document.addEventListener('DOMContentLoaded', () => {
            const authModal = new AuthModal();
            
            // Conectar el botón de login (solo si no está logeado)
            document.getElementById('loginBtn').addEventListener('click', () => {
                authModal.show();
            });
        });
   </script>
</body>
</html>