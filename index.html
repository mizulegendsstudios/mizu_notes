<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mizu Notes - Bloc de Notas Offline</title>
    <style>
        /* Mismo CSS de Mizu */
        :root {
            --primary-color: #4361ee;
            --primary-dark: #3a56d4;
            --secondary-color: #7209b7;
            --accent-color: #4cc9f0;
            --success-color: #4bb543;
            --error-color: #e63946;
            --warning-color: #ff9e00;
            --text-dark: #2b2d42;
            --text-light: #8d99ae;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 15px 30px rgba(0, 0, 0, 0.15);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            background-color: var(--bg-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            width: 100%;
            max-width: 800px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        .container:hover {
            box-shadow: var(--shadow-hover);
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 10px;
            text-align: center;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .subtitle {
            color: var(--text-light);
            text-align: center;
            margin-bottom: 25px;
            font-size: 1rem;
        }

        /* Barra de herramientas */
        .toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-btn {
            padding: 10px 16px;
            border: 2px solid var(--primary-color);
            background: transparent;
            color: var(--primary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .toolbar-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .toolbar-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .toolbar-btn.primary:hover {
            background: var(--primary-dark);
        }

        .toolbar-btn.danger {
            border-color: var(--error-color);
            color: var(--error-color);
        }

        .toolbar-btn.danger:hover {
            background: var(--error-color);
            color: white;
        }

        /* Indicador de estado */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        .status-dot.offline {
            background: var(--error-color);
        }

        .status-dot.syncing {
            background: var(--warning-color);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Lista de notas */
        .notes-sidebar {
            width: 250px;
            background: var(--bg-light);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-right: 20px;
            display: flex;
            flex-direction: column;
        }

        .notes-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .note-item {
            padding: 12px;
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid transparent;
        }

        .note-item:hover {
            background: rgba(67, 97, 238, 0.1);
        }

        .note-item.active {
            background: var(--primary-color);
            color: white;
            border-left-color: var(--secondary-color);
        }

        .note-title {
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .note-preview {
            font-size: 0.8rem;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .note-date {
            font-size: 0.7rem;
            opacity: 0.5;
            margin-top: 4px;
        }

        /* Área principal */
        .main-content {
            flex: 1;
            display: flex;
            gap: 20px;
            min-height: 0;
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-light);
            border-radius: var(--border-radius);
            padding: 25px;
        }

        .note-title-input {
            background: none;
            border: none;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 15px;
            padding: 10px;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .note-title-input:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 2px var(--primary-color);
        }

        .note-content {
            flex: 1;
            background: none;
            border: none;
            resize: none;
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-dark);
            padding: 15px;
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .note-content:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 2px var(--primary-color);
        }

        /* Información de la nota */
        .note-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            font-size: 0.8rem;
            color: var(--text-light);
            display: flex;
            justify-content: space-between;
        }

        /* Estadísticas */
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-light);
        }

        /* Búsqueda */
        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 10px 35px 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        /* Mensaje de estado */
        #messageBox {
            margin-top: 20px;
            padding: 12px;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 500;
            display: none;
        }

        .message-success {
            background-color: rgba(75, 181, 67, 0.1);
            color: var(--success-color);
            display: block;
        }

        .message-error {
            background-color: rgba(230, 57, 70, 0.1);
            color: var(--error-color);
            display: block;
        }

        .message-warning {
            background-color: rgba(255, 158, 0, 0.1);
            color: var(--warning-color);
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                height: auto;
                min-height: 90vh;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .notes-sidebar {
                width: 100%;
                margin-right: 0;
                margin-bottom: 20px;
                max-height: 300px;
            }
            
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .status-indicator {
                margin-left: 0;
                justify-content: center;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .container {
            animation: fadeIn 0.5s ease-out;
        }

        .note-item {
            animation: fadeIn 0.3s ease-out;
        }

        input:focus, button:focus, textarea:focus {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }

        /* Scrollbar personalizado */
        .notes-list::-webkit-scrollbar {
            width: 6px;
        }

        .notes-list::-webkit-scrollbar-track {
            background: var(--bg-light);
            border-radius: 3px;
        }

        .notes-list::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        .notes-list::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* Auto-save indicator */
        .auto-save {
            font-size: 0.8rem;
            color: var(--success-color);
            opacity: 0;
            transition: var(--transition);
        }

        .auto-save.visible {
            opacity: 1;
        }
        
        .empty-state {
            text-align: center;
            color: var(--text-light);
            padding: 40px 20px;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Mizu Notes</h1>
    <p class="subtitle">Bloc de notas offline-first con sincronización inteligente</p>

    <!-- Barra de herramientas -->
    <div class="toolbar">
        <button class="toolbar-btn primary" id="newNoteBtn">
            📄 Nueva Nota
        </button>
        <button class="toolbar-btn danger" id="deleteNoteBtn">
            🗑️ Eliminar
        </button>
        <button class="toolbar-btn" id="exportBtn">
            📤 Exportar
        </button>
        <button class="toolbar-btn" id="importBtn">
            📥 Importar
        </button>
        
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Conectado</span>
        </div>
    </div>

    <!-- Contenido principal -->
    <div class="main-content">
        <!-- Sidebar con lista de notas -->
        <div class="notes-sidebar">
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="Buscar notas...">
                <div class="search-icon">🔍</div>
            </div>
            
            <div class="notes-list" id="notesList">
                <!-- Las notas se cargarán aquí -->
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalNotes">0</div>
                    <div class="stat-label">Notas</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalChars">0</div>
                    <div class="stat-label">Caracteres</div>
                </div>
            </div>
        </div>

        <!-- Editor de notas -->
        <div class="editor-container">
            <input 
                type="text" 
                id="noteTitle" 
                class="note-title-input" 
                placeholder="Título de la nota..."
                maxlength="100"
            >
            <textarea 
                id="noteContent" 
                class="note-content" 
                placeholder="Escribe tu nota aquí..."
                spellcheck="true"
            ></textarea>
            
            <div class="note-info">
                <div>
                    <span id="charCount">0 caracteres</span>
                    <span> • </span>
                    <span id="wordCount">0 palabras</span>
                </div>
                <div class="auto-save" id="autoSaveIndicator">✓ Guardado</div>
                <div id="lastSaved">Última edición: nunca</div>
            </div>
        </div>
    </div>

    <!-- Mensaje de estado -->
    <div id="messageBox" role="alert"></div>
</div>

<script>
    class OfflineNotes {
        constructor() {
            this.notes = new Map();
            this.currentNoteId = null;
            this.isOnline = navigator.onLine;
            this.syncQueue = [];
            this.autoSaveTimeout = null;
            this.lastSyncTime = 0;
            
            this.initializeElements();
            this.initializeEventListeners();
            this.initializeServiceWorker();
            this.loadNotes();
            this.updateUI();
            this.startSyncInterval();
        }

        initializeElements() {
            this.notesList = document.getElementById('notesList');
            this.noteTitle = document.getElementById('noteTitle');
            this.noteContent = document.getElementById('noteContent');
            this.searchInput = document.getElementById('searchInput');
            this.statusDot = document.getElementById('statusDot');
            this.statusText = document.getElementById('statusText');
            this.autoSaveIndicator = document.getElementById('autoSaveIndicator');
            this.lastSaved = document.getElementById('lastSaved');
            this.charCount = document.getElementById('charCount');
            this.wordCount = document.getElementById('wordCount');
            this.totalNotes = document.getElementById('totalNotes');
            this.totalChars = document.getElementById('totalChars');
            this.messageBox = document.getElementById('messageBox');

            // Botones
            this.newNoteBtn = document.getElementById('newNoteBtn');
            this.deleteNoteBtn = document.getElementById('deleteNoteBtn');
            this.exportBtn = document.getElementById('exportBtn');
            this.importBtn = document.getElementById('importBtn');
        }

        initializeEventListeners() {
            // Navegación
            this.newNoteBtn.addEventListener('click', () => this.createNewNote());
            this.deleteNoteBtn.addEventListener('click', () => this.deleteCurrentNote());
            this.exportBtn.addEventListener('click', () => this.exportNotes());
            this.importBtn.addEventListener('click', () => this.importNotes());

            // Búsqueda
            this.searchInput.addEventListener('input', () => this.filterNotes());

            // Editor
            this.noteTitle.addEventListener('input', () => this.handleNoteChange());
            this.noteContent.addEventListener('input', () => this.handleNoteChange());

            // Estado de conexión
            window.addEventListener('online', () => this.handleConnectionChange(true));
            window.addEventListener('offline', () => this.handleConnectionChange(false));

            // Before unload - asegurar que todo se guarde
            window.addEventListener('beforeunload', () => this.forceSave());
        }

        initializeServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            }
        }

        generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        createNewNote() {
            const noteId = this.generateId();
            const note = {
                id: noteId,
                title: 'Nueva Nota',
                content: '',
                createdAt: Date.now(),
                updatedAt: Date.now(),
                version: 1,
                lastSynced: 0
            };

            this.notes.set(noteId, note);
            this.currentNoteId = noteId;
            this.saveNotes();
            this.updateUI();
            this.focusTitle();
            this.displayMessage('Nueva nota creada');
        }

        deleteCurrentNote() {
            if (!this.currentNoteId) {
                this.displayMessage('No hay nota seleccionada para eliminar', true);
                return;
            }

            const noteTitle = this.notes.get(this.currentNoteId)?.title || 'esta nota';
            
            if (confirm(`¿Estás seguro de que quieres eliminar "${noteTitle}"?`)) {
                // Eliminar la nota
                this.notes.delete(this.currentNoteId);
                
                // Encontrar una nueva nota para mostrar
                const remainingNotes = Array.from(this.notes.values());
                let newCurrentNoteId = null;
                
                if (remainingNotes.length > 0) {
                    // Seleccionar la última nota editada
                    const lastEdited = remainingNotes.sort((a, b) => b.updatedAt - a.updatedAt)[0];
                    newCurrentNoteId = lastEdited.id;
                }
                
                this.currentNoteId = newCurrentNoteId;
                this.saveNotes();
                this.updateUI();
                
                // Feedback visual mejorado
                this.displayMessage('Nota eliminada correctamente');
                
                // Si no hay notas, crear una nueva automáticamente después de un momento
                if (!newCurrentNoteId) {
                    setTimeout(() => {
                        this.createNewNote();
                    }, 1000);
                }
            }
        }

        handleNoteChange() {
            if (!this.currentNoteId) return;

            const note = this.notes.get(this.currentNoteId);
            if (!note) return;

            // Actualizar nota
            note.title = this.noteTitle.value;
            note.content = this.noteContent.value;
            note.updatedAt = Date.now();
            note.version++;

            // Auto-save con debounce
            clearTimeout(this.autoSaveTimeout);
            this.autoSaveTimeout = setTimeout(() => {
                this.saveNotes();
                this.showAutoSaveIndicator();
            }, 1000);

            this.updateStats();
            this.updateNoteInList(this.currentNoteId);
        }

        saveNotes() {
            const notesData = Array.from(this.notes.values());
            localStorage.setItem('mizuNotes', JSON.stringify(notesData));
            
            // Agregar a cola de sincronización
            if (this.currentNoteId) {
                this.addToSyncQueue(this.currentNoteId);
            }
        }

        loadNotes() {
            try {
                const saved = localStorage.getItem('mizuNotes');
                if (saved) {
                    const notesData = JSON.parse(saved);
                    this.notes.clear();
                    notesData.forEach(note => {
                        this.notes.set(note.id, note);
                    });

                    // Seleccionar la última nota editada o crear una nueva
                    if (this.notes.size > 0) {
                        const lastEdited = Array.from(this.notes.values())
                            .sort((a, b) => b.updatedAt - a.updatedAt)[0];
                        this.currentNoteId = lastEdited.id;
                    } else {
                        this.createNewNote();
                    }
                } else {
                    this.createNewNote();
                }
            } catch (error) {
                console.error('Error loading notes:', error);
                this.createNewNote();
            }
        }

        addToSyncQueue(noteId) {
            const note = this.notes.get(noteId);
            if (!note) return;

            // Evitar duplicados en la cola
            this.syncQueue = this.syncQueue.filter(item => item.id !== noteId);
            this.syncQueue.push({
                id: noteId,
                version: note.version,
                timestamp: Date.now()
            });

            // Intentar sincronización inmediata
            this.trySync();
        }

        async trySync() {
            if (!this.isOnline || this.syncQueue.length === 0) return;

            this.setStatus('Sincronizando...', 'syncing');

            try {
                // Simular sincronización con servidor
                await this.simulateServerSync();
                
                this.lastSyncTime = Date.now();
                this.syncQueue = []; // Limpiar cola después de sincronización exitosa
                this.setStatus('Conectado', 'online');
                this.displayMessage('Notas sincronizadas', false);
                
            } catch (error) {
                console.error('Sync error:', error);
                this.setStatus('Error de sync', 'offline');
                this.displayMessage('Error al sincronizar', true);
            }
        }

        async simulateServerSync() {
            // Simular latencia de red
            await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
            
            // Simular fallo aleatorio (10% de probabilidad)
            if (Math.random() < 0.1) {
                throw new Error('Error de servidor simulado');
            }

            // Aquí iría la lógica real de sincronización con el servidor
            // Por ahora, solo marcamos las notas como sincronizadas
            this.syncQueue.forEach(syncItem => {
                const note = this.notes.get(syncItem.id);
                if (note) {
                    note.lastSynced = Date.now();
                }
            });
        }

        handleConnectionChange(online) {
            this.isOnline = online;
            
            if (online) {
                this.setStatus('Conectado', 'online');
                this.trySync(); // Intentar sincronizar pendientes
                this.displayMessage('Conexión restaurada - Sincronizando...', false);
            } else {
                this.setStatus('Sin conexión', 'offline');
                this.displayMessage('Modo offline activado', true);
            }
        }

        setStatus(text, status) {
            this.statusText.textContent = text;
            this.statusDot.className = 'status-dot ' + status;
        }

        showAutoSaveIndicator() {
            this.autoSaveIndicator.classList.add('visible');
            this.lastSaved.textContent = `Última edición: ${new Date().toLocaleTimeString()}`;
            
            setTimeout(() => {
                this.autoSaveIndicator.classList.remove('visible');
            }, 2000);
        }

        updateUI() {
            this.renderNotesList();
            this.updateEditor();
            this.updateStats();
        }

        renderNotesList() {
            const filteredNotes = this.getFilteredNotes();
            
            if (filteredNotes.length === 0) {
                if (this.searchInput.value) {
                    this.notesList.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 20px;">No se encontraron notas</div>';
                } else {
                    this.notesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📝</div>
                            <div>No hay notas aún</div>
                            <div style="font-size: 0.8rem; margin-top: 10px;">Crea tu primera nota</div>
                        </div>
                    `;
                }
                return;
            }

            this.notesList.innerHTML = filteredNotes
                .sort((a, b) => b.updatedAt - a.updatedAt)
                .map(note => `
                    <div class="note-item ${note.id === this.currentNoteId ? 'active' : ''}" 
                         data-note-id="${note.id}"
                         onclick="app.selectNote('${note.id}')">
                        <div class="note-title">${this.escapeHtml(note.title) || 'Sin título'}</div>
                        <div class="note-preview">${this.escapeHtml(note.content.substring(0, 50))}${note.content.length > 50 ? '...' : ''}</div>
                        <div class="note-date">${new Date(note.updatedAt).toLocaleDateString()}</div>
                    </div>
                `).join('');
        }

        getFilteredNotes() {
            const searchTerm = this.searchInput.value.toLowerCase();
            const allNotes = Array.from(this.notes.values());
            
            if (!searchTerm) return allNotes;
            
            return allNotes.filter(note => 
                note.title.toLowerCase().includes(searchTerm) ||
                note.content.toLowerCase().includes(searchTerm)
            );
        }

        filterNotes() {
            this.renderNotesList();
        }

        selectNote(noteId) {
            this.currentNoteId = noteId;
            this.updateUI();
            this.focusContent();
        }

        updateEditor() {
            if (!this.currentNoteId) {
                this.noteTitle.value = '';
                this.noteContent.value = '';
                this.noteTitle.placeholder = 'Selecciona o crea una nota';
                this.noteContent.placeholder = 'Selecciona o crea una nota para empezar a escribir';
                this.noteTitle.disabled = true;
                this.noteContent.disabled = true;
                return;
            }

            const note = this.notes.get(this.currentNoteId);
            if (note) {
                this.noteTitle.value = note.title;
                this.noteContent.value = note.content;
                this.noteTitle.placeholder = 'Título de la nota...';
                this.noteContent.placeholder = 'Escribe tu nota aquí...';
                this.noteTitle.disabled = false;
                this.noteContent.disabled = false;
            }
        }

        updateStats() {
            const totalNotes = this.notes.size;
            const totalChars = Array.from(this.notes.values())
                .reduce((sum, note) => sum + note.content.length, 0);
            
            this.totalNotes.textContent = totalNotes;
            this.totalChars.textContent = totalChars.toLocaleString();
            
            // Estadísticas de la nota actual
            const currentContent = this.noteContent.value;
            const charCount = currentContent.length;
            const wordCount = currentContent.trim() ? currentContent.trim().split(/\s+/).length : 0;
            
            this.charCount.textContent = `${charCount} caracteres`;
            this.wordCount.textContent = `${wordCount} palabras`;
        }

        updateNoteInList(noteId) {
            const noteElements = this.notesList.querySelectorAll('.note-item');
            noteElements.forEach(element => {
                if (element.dataset.noteId === noteId) {
                    const note = this.notes.get(noteId);
                    const titleElement = element.querySelector('.note-title');
                    const previewElement = element.querySelector('.note-preview');
                    const dateElement = element.querySelector('.note-date');
                    
                    if (titleElement) titleElement.textContent = note.title || 'Sin título';
                    if (previewElement) previewElement.textContent = note.content.substring(0, 50) + (note.content.length > 50 ? '...' : '');
                    if (dateElement) dateElement.textContent = new Date(note.updatedAt).toLocaleDateString();
                }
            });
        }

        focusTitle() {
            setTimeout(() => this.noteTitle.focus(), 100);
        }

        focusContent() {
            setTimeout(() => this.noteContent.focus(), 100);
        }

        forceSave() {
            this.saveNotes();
        }

        startSyncInterval() {
            // Intentar sincronizar cada 30 segundos cuando esté online
            setInterval(() => {
                if (this.isOnline && this.syncQueue.length > 0) {
                    this.trySync();
                }
            }, 30000);
        }

        // Export/Import functions
        exportNotes() {
            const notesData = Array.from(this.notes.values());
            if (notesData.length === 0) {
                this.displayMessage('No hay notas para exportar', true);
                return;
            }
            
            const dataStr = JSON.stringify(notesData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `mizu-notes-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            this.displayMessage('Notas exportadas correctamente');
        }

        importNotes() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedNotes = JSON.parse(event.target.result);
                        this.mergeImportedNotes(importedNotes);
                    } catch (error) {
                        this.displayMessage('Error al importar notas: archivo inválido', true);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        mergeImportedNotes(importedNotes) {
            // Validar que sea un array
            if (!Array.isArray(importedNotes)) {
                this.displayMessage('Formato de archivo inválido', true);
                return;
            }
            
            let importedCount = 0;
            
            importedNotes.forEach(importedNote => {
                // Validar estructura básica de la nota
                if (!importedNote.title || !importedNote.content) {
                    console.warn('Nota inválida omitida:', importedNote);
                    return;
                }
                
                // Generar nuevo ID para evitar conflictos
                const newId = this.generateId();
                importedNote.id = newId;
                importedNote.importedAt = Date.now();
                importedNote.createdAt = importedNote.createdAt || Date.now();
                importedNote.updatedAt = importedNote.updatedAt || Date.now();
                
                this.notes.set(newId, importedNote);
                importedCount++;
            });
            
            this.saveNotes();
            this.updateUI();
            this.displayMessage(`${importedCount} notas importadas correctamente`);
        }

        escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        displayMessage(message, isError = false) {
            this.messageBox.textContent = message;
            this.messageBox.className = '';
            this.messageBox.style.display = 'block';
            
            if (isError) {
                this.messageBox.classList.add('message-error');
            } else {
                this.messageBox.classList.add('message-success');
            }

            setTimeout(() => {
                this.messageBox.classList.remove('message-error', 'message-success');
                this.messageBox.style.display = 'none';
            }, 4000);
        }
    }

    // Inicializar la aplicación
    let app;
    document.addEventListener('DOMContentLoaded', () => {
        app = new OfflineNotes();
    });
</script>

</body>
</html>
