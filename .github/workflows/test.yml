name: Test and Validate

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        
      - name: Check file structure
        run: |
          echo "üìÅ Checking file structure..."
          ls -la
          echo "Required files:"
          [ -f "index.html" ] && echo "‚úÖ index.html exists" || echo "‚ùå index.html missing"
          [ -f "README.md" ] && echo "‚úÖ README.md exists" || echo "‚ùå README.md missing"
          [ -f "LICENSE" ] && echo "‚úÖ LICENSE exists" || echo "‚ùå LICENSE missing"
          [ -f "VERSION" ] && echo "‚úÖ VERSION exists" || echo "‚ùå VERSION missing"
          
      - name: Validate version format
        run: |
          echo "üè∑Ô∏è Validating version format..."
          if [[ -f "VERSION" ]]; then
            version=$(cat VERSION)
            if [[ $version =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "‚úÖ Version format valid: $version"
            else
              echo "‚ùå Invalid version format: $version (expected: X.Y.Z)"
              exit 1
            fi
          else
            echo "‚ùå VERSION file not found"
            exit 1
          fi
          
      - name: Check for critical issues
        run: |
          echo "üö® Checking for critical issues..."
          
          # Check if HTML has required meta tags
          if grep -q '<meta charset="UTF-8"' index.html; then
            echo "‚úÖ UTF-8 charset declared"
          else
            echo "‚ùå UTF-8 charset not declared"
            exit 1
          fi
          
          # Check if HTML has viewport meta tag
          if grep -q 'viewport' index.html; then
            echo "‚úÖ Viewport meta tag found"
          else
            echo "‚ùå Viewport meta tag missing"
            exit 1
          fi
          
          # Check if JavaScript is properly closed
          if grep -q '</script>' index.html; then
            echo "‚úÖ JavaScript tags properly closed"
          else
            echo "‚ùå JavaScript tags not properly closed"
            exit 1
          fi
          
          # Check if HTML has proper structure
          if grep -q '<!DOCTYPE html>' index.html; then
            echo "‚úÖ DOCTYPE declared"
          else
            echo "‚ùå DOCTYPE missing"
            exit 1
          fi
          
          if grep -q '<html' index.html && grep -q '</html>' index.html; then
            echo "‚úÖ HTML tags properly closed"
          else
            echo "‚ùå HTML tags not properly closed"
            exit 1
          fi
          
      - name: Basic HTML validation
        run: |
          echo "üîç Basic HTML validation..."
          
          # Check for common HTML issues
          if grep -q '<script>' index.html && ! grep -q '</script>' index.html; then
            echo "‚ùå Unclosed script tag found"
            exit 1
          fi
          
          if grep -q '<style>' index.html && ! grep -q '</style>' index.html; then
            echo "‚ùå Unclosed style tag found"
            exit 1
          fi
          
          # Check for balanced tags (basic check)
          open_divs=$(grep -o '<div' index.html | wc -l)
          close_divs=$(grep -o '</div>' index.html | wc -l)
          
          if [ "$open_divs" -ne "$close_divs" ]; then
            echo "‚ö†Ô∏è Warning: Div tags may not be balanced (open: $open_divs, close: $close_divs)"
          else
            echo "‚úÖ Div tags are balanced"
          fi
          
      - name: Test completed
        run: |
          echo "üéâ All tests completed successfully!"
          echo "Mizu Notes is ready for deployment"
          echo "Status check name: 'Test and Validate'"